version: 2.1

description: |
  Send test results to BuildPulse (https://buildpulse.io) to help you identify and eliminate flaky tests.

display:
  home_url: https://github.com/Workshop64/buildpulse-circleci-orb

orbs:
  aws-cli: circleci/aws-cli@0.1.19

commands:
  setup:
    description: |
      Install BuildPulse uploader and optionally configure credentials.
      ðŸ“£ Be sure to run this command *before* running your tests.

    parameters:
      access-key-id:
        description: |
          BuildPulse access key ID. Set this to the name of the environment
          variable you will use to hold this value
          (e.g., BUILDPULSE_ACCESS_KEY_ID).
        type: env_var_name
        default: BUILDPULSE_ACCESS_KEY_ID

      secret-access-key:
        description: |
          BuildPulse secret access key. Set this to the name of the environment
          variable you will use to hold this value
          (e.g., BUILDPULSE_SECRET_ACCESS_KEY).
        type: env_var_name
        default: BUILDPULSE_SECRET_ACCESS_KEY

    steps:
      - run:
          name: Configure BuildPulse region
          command: echo "export BUILDPULSE_REGION=us-east-2" >> $BASH_ENV

      - aws-cli/setup:
          profile-name: buildpulse
          aws-region: BUILDPULSE_REGION
          aws-access-key-id: << parameters.access-key-id >>
          aws-secret-access-key: << parameters.secret-access-key >>

  upload:
    description: Send test results to BuildPulse.

    parameters:
      account-id:
        description: |
          BuildPulse's unique identifier for the account that owns the
          repository.

          You can specify the account ID using this parameter or by setting
          the BUILDPULSE_ACCOUNT_ID environment variable. If the parameter
          is specified and the environment variable is set, the parameter takes
          precedence.
        type: integer
        default: -1

      repository-id:
        description: |
          BuildPulse's unique identifier for the repository.

          You can specify the repository ID using this parameter or by setting
          the BUILDPULSE_REPOSITORY_ID environment variable. If the parameter
          is specified and the environment variable is set, the parameter takes
          precedence.
        type: integer
        default: -1

      path:
        description: |
          Relative path to the directory that contains the XML files for the
          test results (e.g., "test/reports").
        type: string

      when-branch-matches:
        description:
          By default, test results are always uploaded, regardless of the
          current branch. To configure BuildPulse to only upload results for
          certain branches, specify a regular expression to identify branch
          names for the branches that should have their test results uploaded.
        type: string
        default: ".*"

    steps:
      - run:
          name: Send test results to BuildPulse
          when: always
          command: |
            if ! [[ "$CIRCLE_BRANCH" =~ << parameters.when-branch-matches >> ]]
            then
              echo "The current branch (${CIRCLE_BRANCH}) does not match the regex specified in the when-branch-matches parameter (<< parameters.when-branch-matches >>). Skipping BuildPulse upload."
              exit 0
            fi

            if [ << parameters.account-id >> -eq -1 ]
            then
              if [ -z "${BUILDPULSE_ACCOUNT_ID+x}" ]
              then
                echo "No account ID given."
                echo "To resolve this issue, set the buildpulse/upload 'account-id' parameter to your BuildPulse Account ID. Alternatively, you can set the 'BUILDPULSE_ACCOUNT_ID' environment variable to your BuildPulse Account ID."
                exit 1
              else
                ACCOUNT_ID="$BUILDPULSE_ACCOUNT_ID"
              fi
            else
              ACCOUNT_ID=<< parameters.account-id >>
            fi

            if [ << parameters.repository-id >> -eq -1 ]
            then
              if [ -z "${BUILDPULSE_REPOSITORY_ID+x}" ]
              then
                echo "No repository ID given."
                echo "To resolve this issue, set the buildpulse/upload 'repository-id' parameter to the BuildPulse ID for your repository. Alternatively, you can set the 'BUILDPULSE_REPOSITORY_ID' environment variable to the BuildPulse ID for your repository."
                exit 1
              else
                REPOSITORY_ID="$BUILDPULSE_REPOSITORY_ID"
              fi
            else
              REPOSITORY_ID=<< parameters.repository-id >>
            fi

            REPORT_PATH=<< parameters.path >>
            if [ ! -d "$REPORT_PATH" ]
            then
              echo "The given report path is not a directory: ${REPORT_PATH}"
              echo "To resolve this issue, set the buildpulse/upload 'path' parameter to the directory that contains your test report(s)."
              exit 1
            fi

            METADATA_PATH=${REPORT_PATH}/buildpulse.yml
            TIMESTAMP=$(date --iso-8601=seconds)
            UUID=$(cat /proc/sys/kernel/random/uuid)

            cat \<< EOF > "$METADATA_PATH"
            ---
            :branch: $CIRCLE_BRANCH
            :build_url: $CIRCLE_BUILD_URL
            :check: ${BUILDPULSE_CHECK_NAME:-circleci}
            :commit: $CIRCLE_SHA1
            :job: $CIRCLE_JOB
            :repo_name: $CIRCLE_PROJECT_REPONAME
            :repo_owner: $CIRCLE_PROJECT_USERNAME
            :repo_url: $CIRCLE_REPOSITORY_URL
            :timestamp: '$TIMESTAMP'
            :workflow_id: $CIRCLE_WORKFLOW_ID
            EOF

            ARCHIVE_PATH=/tmp/buildpulse-${UUID}.gz
            tar -zcf "${ARCHIVE_PATH}" "${REPORT_PATH}"

            S3_URL=s3://$ACCOUNT_ID.buildpulse-uploads/$REPOSITORY_ID/

            aws s3 cp "${ARCHIVE_PATH}" "${S3_URL}" --profile buildpulse

examples:
  send-test-results-to-buildpulse:
    description: Easily send your test results to BuildPulse in your jobs.
    usage:
      version: 2.1

      orbs:
        buildpulse: workshop64/buildpulse@x.y

      jobs:
        build:
          docker:
            - image: circleci/<some-docker-image>
          steps:
            - checkout

            # ðŸ“£ Be sure to execute this step *before* running your tests
            - buildpulse/setup:
                access-key-id: BUILDPULSE_ACCESS_KEY_ID
                secret-access-key: BUILDPULSE_SECRET_ACCESS_KEY

            - run: echo "Run your tests and generate XML reports for your test results"

            - buildpulse/upload:
                path: test/reports
                account-id: <buildpulse-account-id>
                repository-id: <buildpulse-repository-id>

      workflows:
        version: 2
        commit:
          jobs:
            - build
